<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SEPTA Regional Rail Fare Calculator</title>

    <link href="/css/global.css" type="text/css" media="screen" />
    <!--[if lte IE 8]>
        <link href="/css/ie8.css" media="all" />
    <![endif]-->
</head>
<body>
    <h1>Septa Fare Calculator</h1>
    <h2>Select Ticket:</h2>
    <form id="fareForm" action="#" method="GET">
        <!-- Label for screen reader,
             TODO: I'm a bit fuzzy on this
             Do They need to use ID, or can name work?
           -->
        <label for="zone">Fare Zone</label>
        <br>
        <select name="zone" >
            <option value="1" selected>CCP/1</option>
            <option value="2" >Zone 2</option>
            <option value="3" >Zone 3</option>
            <option value="4" >Zone 4</option>
            <option value="5" >NJ</option>
        </select>
        <br>
        <!-- time is "type" in fare JSON -->
        <label for="time">Travel Time</label>
        <br>
        <select name="time" >
            <option value="weekday" >Weekday</option>
            <option value="evening_weekend" >Weekend Evening</option>
            <option value="anytime" selected>Anytime</option>
        </select>
        <br>
        <!-- location is "purchase" in fare JSON -->
        <fieldset>
            <legend>Purchase Location</legend>
            <input type="radio" name="location" id="loco_1" value="onboard_purchase" />
            <label for="loco_1">Onboard Purchase</label>
            <br>
            <input type="radio" name="location"  id="loco_2" value="advance_purchase" />
            <label for="loco_2">Advanced Purchase</label>
        </fieldset>
        <!-- Multiplier for multiple tickets -->
        <label for="amount">Quantity of Tickets</label>
        <br>
        <input type="number"  name="amount" value="1" min="1" max="100">

        <!-- Have update in realtime, instead of using submit -->
        <!-- <button type="submit">Calculate</button> -->
    </form>

    <h2>You pay:</h2>
    <div id="price">

    </div>

    <script>
     function calculateFare(form, data) {
         var fares = {};
         var price = 0;
         // Find the zone from form data
         switch(form.zone.value) {
             case "1":
                 fares = data.zones[0].fares;
                 break;
             case "2":
                 fares = data.zones[1].fares;
                 break;
             case "3":
                 fares = data.zones[2].fares;
                  break;
             case "4":
                 fares = data.zones[3].fares;
                 break;
             case "5":
                 fares = data.zones[4].fares;
                 break;
         }
         for (let fare of fares) {
             if (fare.purchase === form.location.value) {
                 if (fare.type === form.time.value) {
                     // Except for anytime fare (which is atleast 10)
                     price = fare.price * form.amount.value;
                 }
             }
         }

         console.log(price);
     }



     function loadData() {
         var xhr = new XMLHttpRequest();
         xhr.open("GET", "fares.json", true);
         xhr.onload = function () {
             if (xhr.readyState === xhr.DONE) {
                 if (xhr.status === 200) {
                     //console.log(xhr.response);
                     var data = JSON.parse(xhr.response);
                     console.log(data.zones);
                     form = document.getElementById("fareForm");
                     //console.log(form.amount.value);
                     calculateFare(form, data);
                 }
             }
         };

         xhr.send(null);
     }

     // Set an event listener for a form element on change
     function setEventListener(element) {
         if (element.addEventListener) {
             element.addEventListener("change", loadData, false);
         } else if (element.attachEvent) {
             // for IE 8
             element.addEventListener("change", loadData);
         }
     }


     // The fare should be calculated without the need to submit
     // NOTE: It's not so bad that the xhr request is done so many times
     // because it is going to be cached after the first response
     var inputs = document.querySelectorAll("input");
     var selects = document.querySelectorAll("select");
     inputs.forEach(setEventListener);
     selects.forEach(setEventListener);

     // TODO: stop form from refreshing page
     // form = document.getElementById("fareForm")
     // if (form.addEventListener) {
     //     form.addEventListener("submit", loadData, false);
     // } else if (form.attachEvent) { // for IE
     //    form.attachEvent("submit", loadData)
     // }
    </script>
</body>
</html>
